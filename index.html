<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>In‚ÄëBrowser AI Video (tiny demo)</title>
  <style>
    body{font-family:sans-serif;background:#111;color:#eee;padding:2rem;}
    textarea,button{width:100%;margin:0.5rem 0;padding:0.6rem;font-size:1rem;}
    button{background:#4caf50;color:#111;border:none;cursor:pointer;}
    button:disabled{background:#777;cursor:not-allowed;}
    video{max-width:100%;margin-top:1rem;border:2px solid #4caf50;}
    .log{white-space:pre-wrap;background:#222;padding:0.5rem;margin-top:1rem;font-size:0.9rem;}
  </style>

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <!-- Stable Diffusion tiny (tfjs‚Äëlite) -->
  <script src="https://cdn.jsdelivr.net/npm/@huggingface/tfjs-stable-diffusion@0.1.2/dist/tfjs-stable-diffusion.min.js"></script>
  <!-- ffmpeg.wasm (WebAssembly encoder) -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
</head>

<body>
<h1>üñºÔ∏è‚ÜíüéûÔ∏è In‚ÄëBrowser AI Video (tiny demo)</h1>

<textarea id="prompt" rows="2" placeholder="Enter a short prompt, e.g. 'A red apple on a wooden table'"></textarea>
<button id="runBtn">Generate 8‚Äëframe video (‚âà1‚ÄØs)</button>

<div class="log" id="log"></div>
<video id="output" controls></video>

<script>
(async () => {
  const logEl = document.getElementById('log');
  const btn = document.getElementById('runBtn');
  const videoEl = document.getElementById('output');

  // -------------------------------------------------
  // Helper logging
  const log = (msg) => { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; };
  // -------------------------------------------------

  // Load the tiny Stable Diffusion model (‚âà80‚ÄØMB)
  log('üì¶ Loading Tiny Stable Diffusion (tfjs‚Äëlite)‚Ä¶');
  const sd = await window.tfjsStableDiffusion.load({
    // The model is hosted on Hugging Face; the URL points to a tiny tfjs‚Äëlite checkpoint.
    modelUrl: 'https://huggingface.co/CompVis/stable-diffusion-v1-5/resolve/main/tfjs-lite/model.json',
    // Use the CPU (no WebGPU yet). You can change to "webgl" for GPU‚Äëaccelerated inference if supported.
    backend: 'cpu',
    // Reduce memory footprint ‚Äì we will run the model sequentially for each frame.
    forceHalfPrecision: true,
  });
  log('‚úÖ Model loaded.');

  // Initialize ffmpeg.wasm
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });
  log('‚öôÔ∏è Loading ffmpeg.wasm (‚âà30‚ÄØMB)‚Ä¶');
  await ffmpeg.load();
  log('‚úÖ ffmpeg.wasm ready.');

  // -------------------------------------------------
  // Main generation routine
  // -------------------------------------------------
  btn.onclick = async () => {
    const prompt = document.getElementById('prompt').value.trim();
    if (!prompt) { alert('Please type a prompt'); return; }

    btn.disabled = true;
    log('\nüöÄ Starting generation...');
    const frames = [];
    const FRAME_COUNT = 8;          // 8 frames ‚Üí ~1‚ÄØs at 8‚ÄØfps
    const WIDTH = 512;              // model output size (fixed)
    const HEIGHT = 512;

    for (let i = 0; i < FRAME_COUNT; i++) {
      log(`üñºÔ∏è Generating frame ${i + 1}/${FRAME_COUNT}‚Ä¶`);
      // The tiny model does not support true ‚Äúanimation‚Äù. To give a sense of motion we
      // slightly vary the random seed for each frame.
      const seed = Math.floor(Math.random() * 1e9);
      const imgTensor = await sd.txt2img(prompt, {
        width: WIDTH,
        height: HEIGHT,
        num_inference_steps: 20,   // low steps = faster but noisier
        guidance_scale: 7.5,
        seed: seed,
      });

      // Convert tensor -> PNG data URL
      const pngBlob = await sd.tensorToBlob(imgTensor, 'image/png');
      const pngArray = new Uint8Array(await pngBlob.arrayBuffer());
      const frameName = `frame_${i.toString().padStart(3, '0')}.png`;
      ffmpeg.FS('writeFile', frameName, pngArray);
      frames.push(frameName);

      // Clean up tensors to keep memory low
      imgTensor.dispose();
    }

    // -------------------------------------------------
    // Encode frames into MP4 (8‚ÄØfps)
    // -------------------------------------------------
    log('üéûÔ∏è Encoding frames into MP4 with ffmpeg.wasm...');
    const fps = 8;
    await ffmpeg.run(
      '-framerate', `${fps}`,
      '-i', 'frame_%03d.png',
      '-c:v', 'libx264',
      '-pix_fmt', 'yuv420p',
      '-vf', `scale=${WIDTH}:${HEIGHT}`,
      'out.mp4'
    );

    const data = ffmpeg.FS('readFile', 'out.mp4');
    const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
    const videoURL = URL.createObjectURL(videoBlob);
    videoEl.src = videoURL;

    log('‚úÖ Done! Video ready for playback/download.');
    btn.disabled = false;
  };
})();
</script>
</body>
</html>
